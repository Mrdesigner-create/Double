<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>All-in-One-converter </title>

  <style>
    /* ---------- Styles (keeps same look as your original) ---------- */
    :root { 
        --paper-padding-mm: 10; 
        /* ------------------------------------------------------------------- */
        /* üü¢ CHANGE COLOR HERE: MAIN TOGGLE BUTTON (CONTROL PANEL) */
        /* ------------------------------------------------------------------- */
        --toggle-controls-bg: red;    
        --toggle-controls-border: #388E3C;
        --toggle-controls-icon-color: white; 
    }

    body {
      background: url('https://mrdesigner-create.github.io/photoes/Beautiful-Rose.jpg') center/cover no-repeat fixed !important;
      padding: 20px;
      font-family: Arial, sans-serif;
      box-sizing: border-box;
      margin: 0;
      transition: background 0.6s;
    }
    body.bg-gradient { background: linear-gradient(to bottom right, skyblue, #ff4b4b) !important; }

    /* üí° FIX 1: Align paper to the left for proper margin application during printing */
    #page-wrapper { display:flex; flex-direction:column; align-items:flex-start; width:100%; }

    .a4-page { width:210mm; min-height:297mm; }
    .a5-page { width:148mm; min-height:210mm; }
    .a6-page { width:105mm; min-height:148mm; }
    .us-letter-page { width:8.5in; min-height:11in; }

    .a4-page, .a5-page, .a6-page, .us-letter-page {
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      background:#fff;
      margin-bottom:20px;
      /* Original padding removed. Margins are set by JS as custom padding. */
      padding:10mm; 
      box-sizing:border-box;
    }
    .a4-page.hidden, .a5-page.hidden, .a6-page.hidden, .us-letter-page.hidden { display:none !important; }

    .controls { padding:10px; background:red; border:1px solid #95a5a6; z-index:10000; max-width:360px;
      text-align:center; max-height:80vh; overflow-y:auto; overflow-x:hidden;
      box-shadow: 5px 5px 15px rgba(0,0,0,0.25), inset -2px -2px 5px rgba(255,255,255,0.8);
    }
    .controls-panel-container { position:fixed; top:20px; right:20px; transition:right 1.10s; }
    .controls-panel-container.hidden { right:-382px; }

    /* --- UPDATED: Use variables for color control --- */
    #toggle-controls-btn { 
      position:absolute; top:0; left:-54px; height:68px; width:59px;
      border:1px solid var(--toggle-controls-border); 
      border-right:10px; 
      background:var(--toggle-controls-bg); 
      color: var(--toggle-controls-icon-color); 
      display:flex; align-items:center; justify-content:center;
      border-radius:22px 0 0 20px; cursor:pointer; box-shadow:-10px 0 8px rgba(0,0,0,0.1);
      font-size: 24px; 
    }

    #toggle-bg-btn { position:fixed; top:20px; left:20px; background:yellow; border:1px solid red; box-shadow: 0 8px 8px rgba(0,0,0,0.3); padding:8px 8px; cursor:pointer; z-index:10001; }

    .controls button, .controls select, .controls input[type="number"], .controls input[type="range"], .controls input[type="color"], .controls input[type="checkbox"] {
      padding:10px 12px; margin:6px 0; border:1px solid lightgray; font-size:14px; width:100%; box-sizing:border-box;
      background-color: white; 
    }
    .controls h4 { margin:10px 0 6px; }
    
    #border-color-picker, .controls input[type="range"] {
        background-color: #fff; 
        color: #000;
        font-weight: normal;
    }

    .grid-container { display:grid; gap:0.5mm; width:100%; }

    .box {
      display:flex; justify-content:center; align-items:center; overflow:hidden; position:relative;
      border:0pt solid black; box-sizing:border-box; color:#777; font-size:.8em; cursor:pointer;
      background:white;
    }

    .box-image { width:100%; height:100%; object-fit:cover; display:none; position:absolute; top:0; left:0; }

    .box.selected { outline:2px solid red; box-shadow:0 0 0 2px red; }

    .hidden-input { display:none; }

    .modal { display:none; position:fixed; z-index:20000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); overflow:auto; }
    .modal-content { background:#fff; margin:4% auto; padding:16px; border:1px solid gray; width:92%; max-width:860px; box-shadow:0 4px 8px rgba(0,0,0,0.2); position:relative; }

    .editor-wrapper { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
    .editor-canvas-frame { width:calc(35mm * 2.2); height:calc(45mm * 2.2); background:lightgray; position:relative; overflow:hidden; border:1px solid gray; display:flex; align-items:center; justify-content:center; }
    .editor-image { position:absolute; transform-origin:center center; cursor:grab; user-select:none; -webkit-user-drag:none; }

    .small-note { font-size:13px; color:black; margin-top:5px; }

    @media print {
      .controls-panel-container, .modal, #toggle-controls-btn, #toggle-bg-btn, #togglePaperBtn { display:none; }
      body { padding:0; background-color:white; }
      /* üí° FIX 2: Removed conflicting padding:0!important. JS will set margins as padding. */
      .a4-page, .a5-page, .a6-page, .us-letter-page { 
          width:auto !important; 
          min-height:auto !important; 
          margin:0; 
          /* padding:0; <-- Removed to allow JS inline style padding to take effect */
          box-shadow:none; 
          page-break-after:always; 
      }
      .grid-container { gap:0.5mm !important; }
      .box { border:0pt solid black !important; box-shadow:none !important; background:white !important; cursor:default; }
      .box span, .box.selected { display:none !important; outline:none !important; }
      @page { margin:0; }
    }
    
    /* ------------------------------------------------------------------- */
    /* üü° CHANGE COLOR HERE: UNIQUE BUTTON/SELECT STYLES (Kept as is) */
    /* ------------------------------------------------------------------- */
    #togglePaperBtn {
        background-color: yellow !important; color: black !important; border-color: black !important;
        text-align: center; font-weight: bold !important; border-width: 2px !important;
    }
    #paper-size-select, #photo-size-select, #layout-select, #duplicate-count {
        background-color: purple !important; color: white !important; border-color: yellow !important;
        text-align: center; font-weight: bold !important; border-width: 2px !important;
        -webkit-appearance: none !important; -moz-appearance: none !important; appearance: none !important;         
    }
    #photo-size-select { background-color: navy !important; border-color: purple !important; }
    #layout-select { background-color: #1abc9c !important; border-color: navy !important; }
    #duplicate-count { background-color: #3498db !important; border-color: #2980b9 !important; }
    #custom-cols, #custom-rows {
        background-color: #f39c12 !important; color: #34495e !important; border: 2px solid #1abc9c !important;
        font-weight: bold !important;
    }
    /* Note: This button is now redundant for layout changes but kept for user consistency/manual reset */
    .controls button[onclick="resetGrid()"] {
        background-color: orange !important; color: white !important; border-color: #f39c12 !important;
        text-align: center; font-weight: bold !important; border-width: 2px !important;
    }
    /* Margin and Border Options Container Text (Updated to cover all divs with the specific background) */
    .controls > div[style*="background-color: #f0f8ff"] {
        color: #34495e !important; border: 2px solid orange !important; text-align: center;
    }
    #apply-border-btn {
        background-color: #2980b9 !important; color: white !important; border-color: #f0f8ff !important;
        text-align: center; font-weight: bold !important; border-width: 2px !important;
    }
    #print-btn {
        background-color:  crimson !important; color: white !important; border-color: #3498db !important;
        text-align: center; font-weight: bold !important; border-width: 2px !important;
    }
    #multi-upload-btn {
        background-color: #2ecc71 !important; color: white !important; border-color: #c0392b !important;
        text-align: center; font-weight: bold !important; border-width: 2px !important;
    }
    #single-upload-btn {
        background-color:  #95a5a6 !important; color: white !important; border-color: #2ecc71 !important;
        text-align: center; font-weight: bold !important; border-width: 2px !important;
    }
  </style>
</head>
<body class="bg-image">

  <button id="toggle-bg-btn">üíß Show/Hide</button>

  <div id="controls-panel-container" class="controls-panel-container hidden">
    <div class="controls">
      <button id="toggle-controls-btn">‚óÄ</button>

      <div id="controls-content">
        <button id="togglePaperBtn">Show Screen Paper</button>

        <h4>üìÑ Paper Size:</h4>
        <select id="paper-size-select">
          <option value="a4">A4 (210 x 297 mm)</option>
          <option value="us-letter">US Letter (8.5 x 11 in)</option>
          <option value="a5">A5 (148 x 210 mm)</option>
          <option value="a6">A6 (105 x 148 mm)</option>
        </select>
        
        <div style="background-color: #f0f8ff; padding: 10px; border-radius: 5px;">
            <h4>üìê Paper Margins (mm):</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <input type="number" id="margin-top" min="0" value="0" placeholder="Up (mm)">
                <input type="number" id="margin-bottom" min="0" value="0" placeholder="Bottom (mm)">
                <input type="number" id="margin-left" min="0" value="0" placeholder="Left (mm)">
                <input type="number" id="margin-right" min="0" value="0" placeholder="Right (mm)">
            </div>
            <div class="small-note" style="color:#000;">These values define the printable area.</div>
        </div>
        <h4>üì∏ Photo Size:</h4>
        <select id="photo-size-select">
          <option value="4x6">4x6 in (102x152 mm)</option>
          <option value="5x7">5x7 in (127x178 mm)</option>
          <option value="9x13">3.5x5 in (90x130 mm)</option>
          <option value="30x40">30x40 mm (Passport)</option>
          <option value="35x45" selected>35x45 mm (ID/Visa)</option>
          <option value="4.5">Default (45x45 mm)</option>
        </select>
        <h4>üìê Layout:</h4>
        <select id="layout-select">
          <option value="normal">Normal (Auto-Fit Max)</option>
          <option value="custom">Custom</option>
        </select>

        <div id="custom-layout-options" style="display:none;">
          <input type="number" id="custom-cols" min="1" value="6" placeholder="Columns">
          <input type="number" id="custom-rows" min="1" value="8" placeholder="Rows">
        </div>
        <button onclick="resetGrid()">Apply Layout/Paper/Photo</button>

        <h4>-----------------</h4>
        
        <div style="background-color: #f0f8ff; padding: 10px; border-radius: 5px;"> <h4>üì∏ Border Options (Applies only to selected photos):</h4>
            <label style="text-align:left;"><input id="selection-mode-checkbox" type="checkbox"> Selection mode (click to select)</label>
            <label style="text-align:left;"><input id="show-border-checkbox" type="checkbox"> Show Image Border on Select</label>
            <label style="text-align:left;"><input id="apply-to-all-checkbox" type="checkbox"> Apply to all photos (overwrite selected)</label>
            <input id="border-color-picker" type="color" value="#000000">
            <input id="border-width-input" type="number" step="0.1" min="0" max="10" value="1" placeholder="Width (pt)">
            <button id="apply-border-btn">‚úÖ Apply Border to Selected / Save for Print</button>
        </div> <h4>-----------------</h4>

        <h4>üñºÔ∏è Duplicates (N total copies):</h4>
        <select id="duplicate-count">
          <option value="1">1 (Original only)</option>
          <option value="2" selected>2 (Original +1)</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>

        <h4>-----------------</h4>

        <h4>üì§ Upload Photos:</h4>
        <input id="multi-file-input" class="hidden-input" type="file" accept="image/*" multiple>
        <input id="single-file-input" class="hidden-input" type="file" accept="image/*">
        <input id="replace-file-input" class="hidden-input" type="file" accept="image/*">

        <button id="multi-upload-btn">‚ûï Choose Photos (Creates N copies per file)</button>
        <button id="single-upload-btn">‚ûï Add Single Photo</button>

        <p style="font-size:.85em; margin-top:10px;">Tip: Turn ON <strong>Selection mode</strong> to select many photos. Double-click a photo to edit it.</p>

        <button id="print-btn" onclick="window.print()">üñ®Ô∏è Print All Photo Sheets</button>
      </div>
    </div>
  </div>

  <div id="page-wrapper"></div>

  <div id="edit-modal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <h3>Photo Editor ‚Äî Zoom & Move </h3>

      <div class="editor-wrapper">
        <div class="editor-canvas-frame" id="editor-frame" title="Drag to move; use zoom to scale">
          <img id="editor-img" class="editor-image" src="" alt="edit preview" draggable="false">
        </div>

        <div class="editor-controls">
          <label>Zoom: <input id="zoom-range" type="range" min="50" max="300" value="100"></label>
          <div class="small-note">Drag image to position inside frame. Double-click a photo to edit.</div>

          <hr>

          <label>Brightness: <input id="brightness-slider" type="range" min="50" max="200" value="100"></label>
          <label>Contrast: <input id="contrast-slider" type="range" min="50" max="200" value="100"></label>

          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button id="delete-btn" style="background:red;color:#fff;padding:8px 12px;border:none;">üóëÔ∏è Delete</button>
            <button id="replace-btn" style="background:orange;color:#fff;padding:8px 12px;border:none;">üîÅ Replace</button>
            <button id="save-edit-btn" style="background:green;color:#fff;padding:8px 12px;border:none;">üíæ Save</button>
            <button id="close-modal-btn" style="background:darkslategray;color:#fff;padding:8px 12px;border:none;">Close</button>
          </div>
        </div>
      </div>

      <div style="margin-top:10px;color:#777;font-size:13px">
        After saving, the edited image replaces the original and brightness/contrast are preserved.
      </div>
    </div>
  </div>

<script>
/* ---------- JS: fully working (upload ‚Üí select ‚Üí border ‚Üí print) ---------- */

/* constants */
const GAP_MM = 0.5;
const PAPER_SIZES = {
  'a4': { w:210, h:297 }, 'us-letter': { w:215.9, h:279.4 }, 'a5': { w:148, h:210 }, 'a6': { w:105, h:148 }
};
const PHOTO_SIZES = {
  '4x6': { w: 102, h: 152, text: '4x6 in (102x152 mm)' },
  '5x7': { w: 127, h: 178, text: '5x7 in (127x178 mm)' },
  '9x13': { w: 90, h: 130, text: '3.5x5 in (90x130 mm)' },
  '30x40': { w: 30, h: 40, text: '30x40 mm (Passport)' },
  '35x45': { w: 35, h: 45, text: '35x45 mm (ID/Visa)' },
  '4.5': { w: 45, h: 45, text: 'Default (45x45 mm)' },
};
// Initialize with default selected value (now '35x45')
let currentPhotoWidth = PHOTO_SIZES['35x45'].w;
let currentPhotoHeight = PHOTO_SIZES['35x45'].h;

// üí° Margin property added to currentLayout
let currentLayout = { mode:'normal', cols:0, rows:0, photosPerPage:0, size:'a4', margins: { top: 0, bottom: 0, left: 0, right: 0 } }; 
let currentPageIndex = 0, nextBoxIndex = 1;
let selectedPhotoElements = new Set(); // support multi-select
let userBorderStyle = '0pt solid black'; // saved preference for print/new uploads

/* layout & grid */
function calculateLayout(){
  const size = PAPER_SIZES[currentLayout.size];
  
  // üí° Read custom margins from input fields (defaults to 0 if empty)
  const marginTop = parseFloat(document.getElementById('margin-top').value) || 0;
  const marginBottom = parseFloat(document.getElementById('margin-bottom').value) || 0;
  const marginLeft = parseFloat(document.getElementById('margin-left').value) || 0;
  const marginRight = parseFloat(document.getElementById('margin-right').value) || 0;

  // Store margins in layout for use in createPage
  currentLayout.margins = { top: marginTop, bottom: marginBottom, left: marginLeft, right: marginRight };

  // Calculate printable area by subtracting margins from total paper size
  const printableWidth = size.w - marginLeft - marginRight;
  const printableHeight = size.h - marginTop - marginBottom;
  
  let cols, rows;
  if (currentLayout.mode === 'custom'){
    cols = parseInt(document.getElementById('custom-cols').value) || 1;
    rows = parseInt(document.getElementById('custom-rows').value) || 1;
  } else {
    // Use the calculated printable dimensions to determine max fit
    cols = Math.floor((printableWidth + GAP_MM) / (currentPhotoWidth + GAP_MM));
    rows = Math.floor((printableHeight + GAP_MM) / (currentPhotoHeight + GAP_MM));
  }
  cols = Math.max(1, cols);
  rows = Math.max(1, rows);
  currentLayout.cols = cols; currentLayout.rows = rows; currentLayout.photosPerPage = cols * rows;
}

/* update global photo size based on selection */
function updatePhotoSizeVariable(){
  const sizeKey = document.getElementById('photo-size-select').value;
  const size = PHOTO_SIZES[sizeKey];
  if (size){
    currentPhotoWidth = size.w;
    currentPhotoHeight = size.h;
  }
}

// üí° FIX: Updated resetGrid to save and re-insert photos
window.resetGrid = function(){
  // 1. Store existing photos
  const allPhotos = [];
  document.querySelectorAll('.box[data-has-photo="true"]').forEach(box => {
    const img = box.querySelector('.box-image');
    allPhotos.push({
      imageURL: box.dataset.imageURL,
      filters: img.dataset.filters,
      userBorderStyle: box.dataset.userBorderStyle,
    });
  });

  // 2. Apply new settings and calculate layout
  currentLayout.size = document.getElementById('paper-size-select').value;
  currentLayout.mode = document.getElementById('layout-select').value;
  updatePhotoSizeVariable(); // Ensure photo dimensions are updated before layout calculation
  calculateLayout(); // Recalculate layout based on new settings/margins
  
  // 3. Clear the wrapper and reset page/box index counters
  const wrapper = document.getElementById('page-wrapper');
  wrapper.innerHTML = '';
  currentPageIndex = 0; nextBoxIndex = 1;
  
  // 4. Re-draw the grid (create initial page)
  createPage(0);
  
  // 5. Re-insert all stored photos
  allPhotos.forEach(photo => {
    // Ensure there is a page and space for the photo in the new grid
    checkAndCreateNewPage();
    
    // Insert the photo into the next available box
    updateBox(currentPageIndex, nextBoxIndex, photo.imageURL, photo.filters);
    
    // Also re-apply the saved border style
    const box = document.getElementById(`box-${currentPageIndex}-${nextBoxIndex}`);
    if(box) box.dataset.userBorderStyle = photo.userBorderStyle;
    
    // Advance to the next box
    nextBoxIndex++;
  });
  
  // 6. Final cleanup and print prep
  preparePrintStyles();
  selectedPhotoElements.clear(); // Clear selections since box IDs have changed
};

function createPage(pageIndex){
  const wrapper = document.getElementById('page-wrapper');
  const pageDiv = document.createElement('div');
  pageDiv.classList.add(`${currentLayout.size}-page`);
  pageDiv.id = `page-${pageIndex}`;
  if (document.getElementById('togglePaperBtn').textContent === 'Show Screen Paper') pageDiv.classList.add('hidden');

  // üí° Apply custom padding to the pageDiv based on user margin input
  const m = currentLayout.margins;
  if (m) {
    // CSS padding order: Top, Right, Bottom, Left
    pageDiv.style.padding = `${m.top}mm ${m.right}mm ${m.bottom}mm ${m.left}mm`;
  } else {
    // If margins aren't calculated yet (e.g., initial load), use default 10mm
    pageDiv.style.padding = '10mm'; 
  }
  
  const gridContainer = document.createElement('div');
  gridContainer.classList.add('grid-container');
  gridContainer.id = `grid-${pageIndex}`;
  gridContainer.style.gridTemplateColumns = `repeat(${currentLayout.cols}, ${currentPhotoWidth}mm)`;
  gridContainer.style.gridTemplateRows = `repeat(${currentLayout.rows}, ${currentPhotoHeight}mm)`;

  for (let i=1;i<=currentLayout.photosPerPage;i++){
    const box = document.createElement('div');
    box.classList.add('box');
    box.id = `box-${pageIndex}-${i}`;
    box.style.width = `${currentPhotoWidth}mm`;
    box.style.height = `${currentPhotoHeight}mm`;
    box.style.border = '0pt solid black';
    box.dataset.userBorderStyle = '0pt solid black';
    box.innerHTML = `<img class="box-image" id="box-img-${pageIndex}-${i}" src="" alt="Photo" crossorigin="anonymous"><span>${i}</span>`;
    box.addEventListener('click', boxClickHandler);
    box.addEventListener('dblclick', boxDoubleClickHandler);
    gridContainer.appendChild(box);
  }
  pageDiv.appendChild(gridContainer);
  wrapper.appendChild(pageDiv);
}

/* create new page when needed */
function checkAndCreateNewPage(){
  if (nextBoxIndex > currentLayout.photosPerPage){
    currentPageIndex++; nextBoxIndex = 1; createPage(currentPageIndex);
  }
}

/* update a box with image */
function updateBox(pageIndex, boxIndex, imageURL, filters='brightness(100%) contrast(100%)'){
  const img = document.getElementById(`box-img-${pageIndex}-${boxIndex}`);
  const box = document.getElementById(`box-${pageIndex}-${boxIndex}`);
  if (!img || !box) return;
  img.src = imageURL; img.style.display = 'block'; img.style.filter = filters; img.dataset.filters = filters;
  const span = box.querySelector('span'); if (span) span.style.display = 'none';
  box.dataset.hasPhoto = 'true'; box.dataset.imageURL = imageURL;
  box.dataset.userBorderStyle = userBorderStyle || '0pt solid black'; // store current preference for print/new uploads
  box.style.border = '0pt solid black'; // screen shows border only when selected
}

/* clear box */
function clearBox(boxElement){
  if (!boxElement) return;
  const img = boxElement.querySelector('.box-image');
  const span = boxElement.querySelector('span');
  img.src = ''; img.style.display = 'none'; img.style.filter = ''; img.dataset.filters = '';
  boxElement.style.border = '0pt solid black';
  if (span) span.style.display = 'block';
  boxElement.dataset.hasPhoto = 'false'; boxElement.dataset.imageURL = ''; boxElement.dataset.userBorderStyle = '0pt solid black';
  // remove from selection set if present
  selectedPhotoElements.delete(boxElement.id);
  boxElement.classList.remove('selected');
}

/* upload handlers (rest unchanged) */
function processAndDuplicate(file){
  if (!file) return;
  const totalCopies = parseInt(document.getElementById('duplicate-count').value) || 1;
  const reader = new FileReader();
  reader.onload = function(e){
    const imageURL = e.target.result;
    for (let i=0;i<totalCopies;i++){
      checkAndCreateNewPage();
      updateBox(currentPageIndex, nextBoxIndex, imageURL);
      nextBoxIndex++;
    }
  };
  reader.readAsDataURL(file);
}
function handleSinglePhotoUpload(file){ processAndDuplicate(file); }
function handleMultiPhotoUpload(files){ if (!files || files.length===0) return; Array.from(files).forEach(f => processAndDuplicate(f)); }

/* ----- Border options (rest unchanged) ----- */
function updatePrintBorderVariable(){
  const showBorder = document.getElementById('show-border-checkbox').checked;
  const color = document.getElementById('border-color-picker').value;
  const width = parseFloat(document.getElementById('border-width-input').value) || 0;
  if (showBorder && width > 0){
    userBorderStyle = `${width}pt solid ${color}`;
  } else {
    userBorderStyle = '0pt solid black';
  }
  document.body.style.setProperty('--print-border-style', userBorderStyle);
}

function applyBorderOptions(){
  updatePrintBorderVariable();
  const showBorder = document.getElementById('show-border-checkbox').checked;
  const applyToAll = document.getElementById('apply-to-all-checkbox').checked;

  let targetBoxes;
  if (applyToAll){
    targetBoxes = Array.from(document.querySelectorAll('.box[data-has-photo="true"]'));
    if (targetBoxes.length === 0){
        alert('No photo uploaded yet. Border preference saved for future uploads/prints.');
        return;
    }
  } else {
    const selectedIds = Array.from(selectedPhotoElements);
    if (selectedIds.length === 0){
        alert('No photo selected. Border preference saved for future uploads/prints.');
        return;
    }
    targetBoxes = selectedIds.map(id => document.getElementById(id)).filter(b => b);
  }

  targetBoxes.forEach(box => {
    if (showBorder && userBorderStyle !== '0pt solid black'){
      box.style.border = userBorderStyle; 
      box.dataset.userBorderStyle = userBorderStyle; 
    } else {
      box.style.border = '0pt solid black';
      box.dataset.userBorderStyle = '0pt solid black';
    }
  });
  preparePrintStyles();
}

/* ---------- prepare print styles for boxes that should have border (rest unchanged) ---------- */
function preparePrintStyles(){
  const existing = document.getElementById('print-box-borders');
  if (existing) existing.remove();
  const boxes = Array.from(document.querySelectorAll('.box[data-has-photo="true"]'));
  const rules = [];
  boxes.forEach(box => {
    const style = box.dataset.userBorderStyle || '0pt solid black';
    if (style && style !== '0pt solid black'){
      rules.push(`#${CSS.escape(box.id)}{ border: ${style} !important; }`);
    }
  });
  if (rules.length > 0){
    const styleEl = document.createElement('style');
    styleEl.id = 'print-box-borders';
    styleEl.type = 'text/css';
    styleEl.appendChild(document.createTextNode(rules.join('\n')));
    document.head.appendChild(styleEl);
  }
}
function removePrintStyles(){ const ex = document.getElementById('print-box-borders'); if (ex) ex.remove(); }
window.addEventListener('beforeprint', preparePrintStyles);
window.addEventListener('afterprint', removePrintStyles);

/* ---------- selection and edit handlers (rest unchanged) ---------- */
function boxClickHandler(e){
  const box = e.currentTarget;
  const selectionMode = document.getElementById('selection-mode-checkbox').checked;
  if (selectionMode){
    if (box.dataset.hasPhoto !== 'true') return;
    if (selectedPhotoElements.has(box.id)){
      selectedPhotoElements.delete(box.id);
      box.classList.remove('selected');
      box.style.border = '0pt solid black';
    } else {
      selectedPhotoElements.add(box.id);
      box.classList.add('selected');
      const showBorder = document.getElementById('show-border-checkbox').checked;
      if (showBorder && userBorderStyle !== '0pt solid black') box.style.border = userBorderStyle;
    }
  } else {
    if (box.dataset.hasPhoto === 'true') openEditModalFromBox(box);
  }
}

function boxDoubleClickHandler(e){
  const box = e.currentTarget;
  if (box.dataset.hasPhoto === 'true') openEditModalFromBox(box);
  e.stopPropagation();
}

let _modalEditingBoxId = null;
const editorModal = document.getElementById('edit-modal');
const editorFrame = document.getElementById('editor-frame');
const editorImg = document.getElementById('editor-img');
const zoomRange = document.getElementById('zoom-range');
const brightnessSlider = document.getElementById('brightness-slider');
const contrastSlider = document.getElementById('contrast-slider');
const saveEditBtn = document.getElementById('save-edit-btn');
const deleteBtn = document.getElementById('delete-btn');
const replaceBtn = document.getElementById('replace-btn');
const closeModalBtn = document.getElementById('close-modal-btn');
const replaceFileInput = document.getElementById('replace-file-input');
let editingState = { pageIndex:null, boxIndex:null, imgNaturalWidth:0, imgNaturalHeight:0, posX:0, posY:0, scale:1, brightness:1, contrast:1, isDragging:false, dragStart:{x:0,y:0}, imgOffsetOnDragStart:{x:0,y:0} };

function openEditModalFromBox(boxElement){
  const prevSelected = Array.from(document.querySelectorAll('.box.selected'));
  prevSelected.forEach(b => b.classList.remove('selected'));
  boxElement.classList.add('selected');
  _modalEditingBoxId = boxElement.id;
  openEditModal({ currentTarget: boxElement });
}

function openEditModal(event){
  const boxElement = event.currentTarget;
  if (boxElement.dataset.hasPhoto !== 'true') return;
  boxElement.classList.add('selected');
  _modalEditingBoxId = boxElement.id;
  const showBorder = document.getElementById('show-border-checkbox').checked;
  const saved = boxElement.dataset.userBorderStyle || '0pt solid black';
  if (showBorder && saved !== '0pt solid black') boxElement.style.border = saved;
  else if (showBorder && userBorderStyle !== '0pt solid black') boxElement.style.border = userBorderStyle;
  else boxElement.style.border = '0pt solid black';

  const parts = boxElement.id.split('-'); const pageIndex = Number(parts[1]); const boxIndex = Number(parts[2]);
  const imgElement = boxElement.querySelector('.box-image'); const currentFilters = imgElement.dataset.filters || 'brightness(100%) contrast(100%)';
  const brightnessMatch = currentFilters.match(/brightness\((\d+)%\)/); const contrastMatch = currentFilters.match(/contrast\((\d+)%\)/);
  const brightnessValue = brightnessMatch ? Number(brightnessMatch[1]) : 100;
  const contrastValue = contrastMatch ? Number(contrastMatch[1]) : 100;

  editingState.pageIndex = pageIndex; editingState.boxIndex = boxIndex; editingState.posX = 0; editingState.posY = 0; editingState.scale = 1;
  editingState.brightness = brightnessValue/100; editingState.contrast = contrastValue/100;

  editorImg.src = imgElement.src;
  editorImg.style.left = '0px'; editorImg.style.top = '0px'; editorImg.style.visibility = 'hidden';
  zoomRange.value = 100; brightnessSlider.value = brightnessValue; contrastSlider.value = contrastValue;

  editorImg.onload = function(){
    editingState.imgNaturalWidth = editorImg.naturalWidth; editingState.imgNaturalHeight = editorImg.naturalHeight;
    fitImageToFrame(); applyEditorTransform(); editorImg.style.visibility = 'visible';
  };

  editorModal.style.display = 'block'; editorModal.setAttribute('aria-hidden','false');
}

function fitImageToFrame(){
  const frameRect = editorFrame.getBoundingClientRect();
  const fw = frameRect.width, fh = frameRect.height;
  const iw = editingState.imgNaturalWidth, ih = editingState.imgNaturalHeight;
  const scaleX = fw/iw, scaleY = fh/ih;
  const baseScale = Math.max(scaleX, scaleY);
  editingState.scale = baseScale;
  editingState.posX = (fw - iw*baseScale)/2; editingState.posY = (fh - ih*baseScale)/2;
  zoomRange.value = Math.round(editingState.scale/baseScale*100);
}
function applyEditorTransform(){
  const s = editingState.scale;
  editorImg.style.width = (editingState.imgNaturalWidth * s) + 'px';
  editorImg.style.height = (editingState.imgNaturalHeight * s) + 'px';
  editorImg.style.left = editingState.posX + 'px';
  editorImg.style.top = editingState.posY + 'px';
  editorImg.style.transform = 'translate3d(0,0,0)';
  editorImg.style.filter = `brightness(${editingState.brightness*100}%) contrast(${editingState.contrast*100}%)`;
}
function computeBaseScale(){
  const frameRect = editorFrame.getBoundingClientRect();
  const fw = frameRect.width, fh = frameRect.height;
  const iw = editingState.imgNaturalWidth, ih = editingState.imgNaturalHeight;
  const scaleX = fw/iw, scaleY = fh/ih;
  return Math.max(scaleX, scaleY);
}

zoomRange.addEventListener('input', ()=>{
  const frameRect = editorFrame.getBoundingClientRect(); const fw = frameRect.width, fh = frameRect.height;
  const baseFit = computeBaseScale(); const percent = Number(zoomRange.value)/100; const newScale = baseFit * percent;
  const centerX = fw/2, centerY = fh/2;
  const prevScale = editingState.scale, prevImgLeft = editingState.posX, prevImgTop = editingState.posY;
  const imgCenterX = (centerX - prevImgLeft)/prevScale, imgCenterY = (centerY - prevImgTop)/prevScale;
  const newLeft = centerX - imgCenterX * newScale; const newTop = centerY - imgCenterY * newScale;
  editingState.scale = newScale; editingState.posX = newLeft; editingState.posY = newTop; applyEditorTransform();
});
editorImg.addEventListener('mousedown', (e)=>{ e.preventDefault(); editingState.isDragging = true; editorImg.style.cursor = 'grabbing'; editingState.dragStart = { x:e.clientX, y:e.clientY }; editingState.imgOffsetOnDragStart = { x:editingState.posX, y:editingState.posY }; });
window.addEventListener('mousemove', (e)=>{ if(!editingState.isDragging) return; const dx = e.clientX - editingState.dragStart.x; const dy = e.clientY - editingState.dragStart.y; editingState.posX = editingState.imgOffsetOnDragStart.x + dx; editingState.posY = editingState.imgOffsetOnDragStart.y + dy; applyEditorTransform(); });
window.addEventListener('mouseup', ()=>{ editingState.isDragging = false; editorImg.style.cursor = 'grab'; });
function updateBrightnessContrastFromSliders(){ editingState.brightness = Number(brightnessSlider.value)/100; editingState.contrast = Number(contrastSlider.value)/100; applyEditorTransform(); }
brightnessSlider.addEventListener('input', updateBrightnessContrastFromSliders); contrastSlider.addEventListener('input', updateBrightnessContrastFromSliders);

saveEditBtn.addEventListener('click', ()=>{
  if (editingState.pageIndex == null) return;
  const DPI = 300; const pxPerMm = DPI/25.4;
  const targetW_px = Math.round(currentPhotoWidth * pxPerMm); const targetH_px = Math.round(currentPhotoHeight * pxPerMm);
  const canvas = document.createElement('canvas'); canvas.width = targetW_px; canvas.height = targetH_px; const ctx = canvas.getContext('2d');

  const frameRect = editorFrame.getBoundingClientRect(); const fw = frameRect.width, fh = frameRect.height;
  const off = document.createElement('canvas'); off.width = editingState.imgNaturalWidth; off.height = editingState.imgNaturalHeight; const offctx = off.getContext('2d');
  offctx.filter = `brightness(${editingState.brightness*100}%) contrast(${editingState.contrast*100}%)`;
  const tempImg = new Image(); tempImg.crossOrigin = 'anonymous';
  tempImg.onload = function(){
    offctx.drawImage(tempImg, 0, 0, off.width, off.height);
    const scale = editingState.scale;
    const imageX0 = (0 - editingState.posX) / scale;
    const imageY0 = (0 - editingState.posY) / scale;
    const imageW = fw / scale; const imageH = fh / scale;
    const sx = Math.max(0, imageX0); const sy = Math.max(0, imageY0);
    const sWidth = Math.max(1, Math.min(off.width - sx, imageW - (sx - imageX0)));
    const sHeight = Math.max(1, Math.min(off.height - sy, imageH - (sy - imageY0)));
    ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    try { ctx.drawImage(off, sx, sy, sWidth, sHeight, 0, 0, canvas.width, canvas.height); } catch(err){ console.error(err); ctx.drawImage(off, 0,0,off.width,off.height,0,0,canvas.width,canvas.height); }
    // üí° QUALITY CHANGE: Changed 0.92 to 1.0 (Max JPEG Quality)
    const dataURL = canvas.toDataURL('image/jpeg', 1.0);
    const pageIndex = editingState.pageIndex; const boxIndex = editingState.boxIndex;
    updateBox(pageIndex, boxIndex, dataURL, 'brightness(100%) contrast(100%)');
    closeModal();
  };
  tempImg.src = editorImg.src;
});

deleteBtn.addEventListener('click', ()=>{
  if (!_modalEditingBoxId) return;
  const box = document.getElementById(_modalEditingBoxId);
  clearBox(box);
  closeModal();
});
replaceBtn.addEventListener('click', ()=> replaceFileInput.click());
replaceFileInput.addEventListener('change', (ev)=>{
  const f = ev.target.files[0]; if (!f || !_modalEditingBoxId) return;
  const reader = new FileReader();
  reader.onload = function(e){
    const box = document.getElementById(_modalEditingBoxId);
    const existingFilters = box.querySelector('.box-image').dataset.filters || 'brightness(100%) contrast(100%)';
    const parts = box.id.split('-'); const pageIndex = Number(parts[1]); const boxIndex = Number(parts[2]);
    updateBox(pageIndex, boxIndex, e.target.result, existingFilters);
    closeModal();
  };
  reader.readAsDataURL(f);
});

closeModalBtn.addEventListener('click', closeModal);
function closeModal(){
  editorModal.style.display = 'none'; editorModal.setAttribute('aria-hidden','true');
  if (_modalEditingBoxId){
    const modalBox = document.getElementById(_modalEditingBoxId);
    if (modalBox && !selectedPhotoElements.has(modalBox.id)){
      modalBox.classList.remove('selected');
      modalBox.style.border = '0pt solid black';
    }
  }
  _modalEditingBoxId = null;
  editingState.pageIndex = null; editingState.boxIndex = null;
}

/* ---------- small utilities & init (rest unchanged) ---------- */

function toggleControls(){ 
  const panel = document.getElementById('controls-panel-container'); 
  panel.classList.toggle('hidden'); 
  const btn = document.getElementById('toggle-controls-btn'); 
  const ICON_SHOW = '‚ò∞'; 
  const ICON_HIDE = '‚úñ'; 

  if (panel.classList.contains('hidden')) { 
    btn.innerHTML = ICON_SHOW; 
  } else { 
    btn.innerHTML = ICON_HIDE; 
  } 
}

function togglePaper(){
  const allPages = document.querySelectorAll('.a4-page, .a5-page, .a6-page, .us-letter-page');
  allPages.forEach(p=>p.classList.toggle('hidden'));
  const button = document.getElementById('togglePaperBtn');
  if (allPages[0] && allPages[0].classList.contains('hidden')) button.textContent = 'Show Screen Paper'; else button.textContent = 'Hide Screen Paper';
}
function toggleBackground(){
  document.body.classList.toggle('bg-image'); document.body.classList.toggle('bg-gradient');
  document.getElementById('toggle-bg-btn').textContent = document.body.classList.contains('bg-image') ? 'üíß Show Gradient Background' : 'üåà Show Background Image';
}

/* ---------- Initialization (Updated for Live Update) ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  // initial hide pages
  const allPages = document.querySelectorAll('.a4-page, .a5-page, .a6-page, .us-letter-page');
  allPages.forEach(p=>p.classList.add('hidden'));
  document.getElementById('togglePaperBtn').textContent = 'Show Screen Paper';

  // bind control toggles
  document.getElementById('toggle-controls-btn').addEventListener('click', toggleControls);
  document.getElementById('toggle-bg-btn').addEventListener('click', toggleBackground);

  // border controls
  updatePrintBorderVariable();
  document.getElementById('apply-border-btn').addEventListener('click', applyBorderOptions);
  document.getElementById('show-border-checkbox').addEventListener('change', updatePrintBorderVariable);
  document.getElementById('border-color-picker').addEventListener('input', updatePrintBorderVariable);
  document.getElementById('border-width-input').addEventListener('input', updatePrintBorderVariable);

  // --- START OF LIVE UPDATE BINDINGS ---
  
  // 1. Paper Margins: Live update on input
  const marginInputs = document.querySelectorAll('#margin-top, #margin-bottom, #margin-left, #margin-right');
  marginInputs.forEach(input => input.addEventListener('input', resetGrid));

  // 2. Photo Size: Live update on change
  document.getElementById('photo-size-select').addEventListener('change', ()=>{
    updatePhotoSizeVariable();
    resetGrid();
  });
  
  // 3. Paper Size: Live update on change
  document.getElementById('paper-size-select').addEventListener('change', resetGrid);

  // 4. Layout Selection: Live update on change and toggle custom options
  document.getElementById('layout-select').addEventListener('change', ()=>{
    document.getElementById('custom-layout-options').style.display = document.getElementById('layout-select').value === 'custom' ? 'block' : 'none';
    resetGrid();
  });
  
  // 5. Custom Columns/Rows: Live update on input
  document.getElementById('custom-cols').addEventListener('input', resetGrid);
  document.getElementById('custom-rows').addEventListener('input', resetGrid);

  // --- END OF LIVE UPDATE BINDINGS ---
  
  // Initial setup
  updatePhotoSizeVariable();
  calculateLayout();
  createPage(0);

  document.getElementById('togglePaperBtn').addEventListener('click', togglePaper);

  // upload listeners
  const multiFileInput = document.getElementById('multi-file-input');
  const singleFileInput = document.getElementById('single-file-input');

  document.getElementById('multi-upload-btn').addEventListener('click', ()=> multiFileInput.click());
  document.getElementById('single-upload-btn').addEventListener('click', ()=> singleFileInput.click());

  multiFileInput.addEventListener('change', (ev)=>{ handleMultiPhotoUpload(ev.target.files); ev.target.value = null; });
  singleFileInput.addEventListener('change', (ev)=>{ handleSinglePhotoUpload(ev.target.files[0]); ev.target.value = null; });

  // keyboard escape to close modal
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && editorModal.style.display === 'block') closeModal(); });
});

/* End of script */
</script>
</body>
</html>
